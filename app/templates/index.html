{% extends "layout.html" %}

{% block style %}
    <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='css/style.css')}}">
    {% endblock %}
    {% block body %}
            <div class="w-25 mx-auto main-div">
        <div class="container card px-0 pb-3 pt-2" style="padding:0px!important" >
          {% include "flash.html" %}
          <div class="d-flex " style="box-shadow: 0px 2px 10px rgb(0 0 0 / 25%);
    z-index: 10;">
                    <div class="d-flex align-items-center ms-3">
                      <a href="/"><i class="fa fa-arrow-left me-2" aria-hidden="true"></i></a>
                        <img class="rounded-circle border pfp border-dark"  src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fcdn3.iconfinder.com%2Fdata%2Ficons%2Fpopular-services-brands-vol-2%2F512%2Fstackoverflow-512.png&f=1&nofb=1" width=35 height=35>
                        </img>
                    </div>
                    <div class="ps-2">
                        <span class="fw-bold">
                            {{user.username}}
                        </span>
                        <br>
                            <span>
                                Online
                            </span>
                        </br>
                    </div>
                </div>
    <div id="container" style="overflow-y: auto; height:100%; background: #f8f8f8">
      {% if message|length == 0 %}
      <div class="px-2 d-flex align-items-center justify-content-center h-100 empty">
                            <p class="text-center text-muted">
                                No messages available. Once You send they will appear here
                            </p>
                        </div>
                      {% endif %}
      {% for i in message %}

        
      
        <div class="d-flex" style="float: {{i.msg_type}}; clear: both; margin: 5px; ">
          {% if i.msg_type == "left" %}
        <img class="rounded-circle border pfp border-dark"  src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fcdn3.iconfinder.com%2Fdata%2Ficons%2Fpopular-services-brands-vol-2%2F512%2Fstackoverflow-512.png&f=1&nofb=1" width=25 height=25>
        {% endif %}
        <div class="message  {{i.msg_type}}">{{i.msg}} <sub>{{i.time}}</sub></div>
      </div>
      {% endfor %}
       <button class="scroll btn btn-light btn-sm" type="button" ><i class="fas fa-angle-down" ></i></button>
    </div>
   
<div class="input-group" style="box-shadow: 0px -3px 10px rgb(0 0 0 / 25%); z-index: 10;">
  <input type="text" id="my_inp" class="form-control" placeholder="Type a message...">
  <button class="btn btn-dark" type="submit" id="send"><i class="fab fa-telegram-plane"></i></button>
</div>

</div>
</div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script src="{{url_for('static',filename='app.js')}}"></script>

   <script type="text/javascript">
    function resize_div(){
      $(".message").css({"max-width":`${$(".card").width()-100}px` })
    }


     function write(msg, pos ) {
      d = Date()
      date = `${d.getMonth()+1}-${d.getDate()} ${d.getHours()}-${d.getMinutes()}`
      $("#container").append(`<div class="d-flex" style="float: ${pos}; clear: both; margin: 5px; ">
          ${pos=="left" ? 
      '<img class="rounded-circle border pfp border-dark"  src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fcdn3.iconfinder.com%2Fdata%2Ficons%2Fpopular-services-brands-vol-2%2F512%2Fstackoverflow-512.png&f=1&nofb=1" width=25 height=25>' : ''
}
        
        <div class="message ${pos}">${msg}</div>
      </div>
      
      `
      )
     

    container.scrollTop = container.scrollHeight - container.clientHeight;
    resize_div()
}

 $(document).ready(function(){
   resize_div()
  $(window).resize( function(){
    resize_div()

});
  container.scrollTop = container.scrollHeight - container.clientHeight;
      
      $(container).scroll(function(){

            if (container.scrollTop < container.scrollHeight - container.clientHeight){
            $(".scroll").fadeIn()
        }
        else{
            $(".scroll").fadeOut()

        }

    })
    $(".scroll").click(function (e){
        container.scroll({
            top:container.scrollHeight - container.clientHeight,
            behavior:"smooth"
        })

    })

    socket = io.connect(document.href );
    socket.on('connect', function() {
        
  });
  socket.on("connected", data => {
    console.log(data)
  })

   $(document).keypress(event=>{
    if (event.which == 13) {
       $("#send").trigger("click")
     }

   })
  $("#send").click(function(e){
    // e.preventDefault()
    socket.emit("message",{msg:$("#my_inp").val(),user:"{{user.username}}"},(d)=>{
      if (d == "done!"){
        console.log("client recieved the message")
      }
    })
    // write($("#my_inp").val(),"right")
    $("#my_inp").val("")
  })
  socket.on("msg", data => {
    $(".empty").remove()
    console.log(data)
    if (data.user == "{{current_user.username}}"){
      if (data.rec_user == document.location.pathname.slice(6)) {
      write(data.msg,"right")  
      }
    }
    else if (data.user == document.location.pathname.slice(6)) {
      write(data.msg,"left")
    }
  })
});
   </script>
    {% endblock %}